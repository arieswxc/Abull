.pg-container-content
  #pg-account-index.pg-account
    .container_12.mt10.fn-clear
      = render "shares/profile_side_navbar", {activeItem: "useredit"}
      .inline-block.relative.pg-account-detail
        .tab-v1
          %ul.nav.nav-tabs
            %li.active
              %a{"data-toggle" => "tab", :href => "#baseProfile"} 基本信息
            %li
              %a{"data-toggle" => "tab", :href => "#authenticationProfile"} 认证信息
          .tab-content
            #baseProfile.tab-pane.fade.active.in
              = form_for(resource, as: resource_name, url: registration_path(resource_name), html: { method: :put, class: 'sky-form'}) do |f|
                = devise_error_messages!
                .row
                  .ml40.col-md-2.text-center
                    .row
                      .input-image-wrapper.h70.w70.margin-auto.mb10-i
                        .input.input-file.input-image.pointer
                          .button
                            %input#selectAvatar.pointer{:type =>"file", :multiple => "", :accept => "image/*"}
                            %img.img-thumbnail.img-rounded.mw70.mh70{:src => "#{current_user.avatar.url}"}/
                      -# .progress.w100
                      -#   #progressBar.progress-bar.progress-bar-info.progress-bar-striped{"aria-valuemax" => "100", "aria-valuemin" => "0", "aria-valuenow" => "0", :role => "progressbar", :style => "width: 0%"}
                      -#     0%
                      .mb40 上传头像
                  .row
                    .col-md-8
                      .border-all.mt10
                        %dt 个人简介：
                        .input
                          %input{:name => "user[abstract]", :type => "text", :value => "#{resource.abstract}"}/
                %dl.dl-horizontal
                  %dt 昵称
                  %dd
                    %section
                      %label.input
                        %i.icon-append.fa.fa-user
                        %input{:name => "user[username]", :placeholder => "Username", :type => "text", :value => "#{resource.username}"}/
                        %b.tooltip.tooltip-bottom-right 登录网站所用
                  %dt 邮箱
                  %dd
                    %section
                      %label.input
                        %i.icon-append.fa.fa-envelope
                        %input{:name => "user[email]", :placeholder => "Email address", :type => "email", :value => "#{resource.email}"}/
                        %b.tooltip.tooltip-bottom-right 验证账户所用
                  %dt 密码
                  %dd
                    %section
                      %label.input
                        %i.icon-append.fa.fa-lock
                        %input#password{:name => "user[password]", :placeholder => "Password", :type => "password"}/
                        %b.tooltip.tooltip-bottom-right 不要忘了你的密码
                  %dt 确认密码
                  %dd
                    %section
                      %label.input
                        %i.icon-append.fa.fa-lock
                        %input{:name => "user[password_confirmation]", :placeholder => "Confirm password", :type => "password"}/
                        %b.tooltip.tooltip-bottom-right 不要忘了你的密码
                %button.btn-u.btn-u-default.ml100{:type => "reset"} Cancel
                %button.btn-u{:type => "submit"} 保存修改
            #authenticationProfile.tab-pane.fade
              %h3 实名认证
              %hr
              = simple_nested_form_for(@user,url: investor_applied_user_path(current_user),   |
                html: { class: 'form-horizontal sky-form', id: 'authentication_form',enctype: "multipart/form-data" },                     |
                wrapper: :horizontal_form,                              |
                wrapper_mappings: {                                     |
                check_boxes: :horizontal_radio_and_checkboxes,          |
                radio_buttons: :horizontal_radio_and_checkboxes,      |
                file: :horizontal_file_input,                         |
                boolean: :horizontal_boolean}) do |f|                 |
                - if current_user.real_name.blank?
                  = f.input :real_name
                  = f.input :id_card_number
                - else
                  .form-group.optional
                    %label.optional.col-sm-3.control-label
                      %span
                        = User.human_attribute_name('real_name')
                        \:
                    .col-sm-9.mt5
                      %span.bold= current_user.real_name
                  .form-group.optional
                    %label.optional.col-sm-3.control-label
                      %span
                        = User.human_attribute_name('id_card_number')
                        \:
                    .col-sm-9.mt5
                      %span.bold= current_user.id_card_number
                = f.fields_for :photos do |photo_form|
                  .form-group.optional
                    %label.optional.col-sm-3.control-label
                      %span{:name => "user[photos_attributes][#{photo_form.index}][title]", :value => "#{photo_form.object.title}"}= photo_form.object.title
                    .col-sm-9
                      %label.input.input-file
                        .button
                          %input{:type =>"file", :name =>"user[photos_attributes][#{photo_form.index}][photo]", :multiple => "", :onchange => "this.parentNode.nextElementSibling.value = this.value", :accept => "image/*"} 浏览
                        %input{:type => "text", :readonly => ""}
                  .text-center
                    = image_tag current_user.photos[photo_form.index].photo.url,class: "img-thumbnail img-rounded #{'w300' if !current_user.photos[photo_form.index].photo.blank?}"
                .text-center
                  = f.button :submit
              %hr
              %h3 发表人审核
              %hr
              = simple_nested_form_for(@user,url: trader_applied_user_path(current_user),  |
                html: { class: 'form-horizontal sky-form', id: 'trader_authentication_form',enctype: "multipart/form-data" },                   |
                wrapper: :horizontal_form,                            |
                wrapper_mappings: {                                   |
                check_boxes: :horizontal_radio_and_checkboxes,        |
                radio_buttons: :horizontal_radio_and_checkboxes,      |
                file: :horizontal_file_input,                         |
                boolean: :horizontal_boolean}) do |f|                 |
                = f.input :real_name, disabled: true, as: :hidden
                = f.input :cell, input_html: {class: 'numberic', maxlength: '11', pattern: "\d{3}-\d{8}|\d{4}-\{7,8}"}
                = f.input :birthday, as: :date, html5: true
                = f.input :gender, collection: [:male, :female],include_blank: false
                = f.input :education
                = f.input :address
                = f.input :job
                .text-center
                  = f.button :submit
:javascript
  // var xhr_provider = function(){
  //   var xhr = jQuery.ajaxSettings.xhr();
  //   if(progressFunction && xhr.upload) {
  //     xhr.upload.addEventListener("progress", progressFunction, false);
  //   }
  //   return xhr;
  // };
  // function progressFunction(evt){
  //   var progressBar = document.getElementById("progressBar");
  //   if(evt.lengthComputable){
  //     var percent = Math.round(evt.loaded /evt.total * 100);
  //     $("#progressBar").attr("aria-valuenow",percent);
  //     $("#progressBar").css("width", percent + "%");
  //     $("#progressBar").html(percent + "%");
  //   }
  // }
  $(function() {
    var ptn = /\/users\/edit\/#authencation*$/;
    if (ptn.test(window.location.href)) {
      $("#pg-account-index .tab-v1 ul.nav.nav-tabs li:nth-child(2) a").tab('show');
    }

    $("#selectAvatar").on('change',function(){
      var _self = this;
      if (_self.files.length == 0) return;
      var data = new FormData();
      data.append('avatar', _self.files[0]);
      $.ajax({
        data:data,
        url: "/users/#{current_user.id}/save_avatar",
        type: 'post',
        contentType: false,
        processData: false,
        // xhr: xhr_provider,
        success: function () {
          var reader = new FileReader();
          reader.onload = function(event) {
              var dataUri = event.target.result,
                    img  = _self.nextElementSibling;
              img.src = dataUri;
          };

          reader.onerror = function(event) {
              console.error("File could not be read! Code " + event.target.error.code);
          };

          reader.readAsDataURL(_self.files[0]);
        },
        error: function () {

        }
      });
    });
  });
