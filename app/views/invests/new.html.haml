.container.content
  - if current_user && current_user.level == 'unverified'
    .text-center.min-height300.pt80
      %h3 请进行实名认证
      = link_to "点此进行实名认证", investor_apply_user_path(current_user)
  - elsif current_user && current_user.level == 'investor_applied'
    .text-center.min-height300.pt80
      %h3 您已提交实名认证申请，请等待审核
  - else
    - if @fund.private_check == 'private'
      .p20.text-center
        %label 暗号:
        %input.unlock_val
        %a.btn-u.btn-u-orange.btn-u-xs.unlock_btn UNLOCK
    .row.mt10
      = render 'users/funder_info',{user: @fund.user}
    .row
      - if @fund.state == "gathering"
        - if @flag
          .col-md-8.fund_base_info
            = render 'funds/fund_base_info'
          .col-md-4.new_invest_form
            = render 'form'
        - else
          .col-md-12.fund_base_info
            = render 'funds/fund_base_info'
          .col-md-4.hide.new_invest_form
            = render 'form'
      - else
        .col-md-12.fund_base_info
          = render 'funds/fund_base_info'
    .tag-box.tag-box-v3.mt20.p20.pt0
      .row
        .col-md-8
          .headline.headline-md.relative
            %h4 当前标的业绩
          .text-center
            %span.chart-label1
            %span.mr15 我的业绩
            %span.chart-label2
            %span 沪深300
            %canvas#fund_history_chart.chart_box.h200
        .col-md-4
          .headline.headline-md
            %h4 当前标的数据
            = link_to "更多","#",class: "float-right"
          .mt10
            - if @fund_list_array
              %table.table.table-striped
                %thead
                  %tr
                    %th 日期
                    %th 净值
                %tbody
                  - @list_array.each do |f|
                    %tr
                      %td
                        = f[0]
                      %td
                        = f[1]
            - else
              %h2.text-center 还没有历史数据
      .row
        .col-md-12
          .headline.headline-md
            %h4 证明图片
          .mt10
            - if @check_user_bid === 'true'
              - if @fund_verify_photos && !@fund_verify_photos.empty?
                .owl-carousel-v2.owl-carousel-style-v1
                  .owl-slider-v2
                    - @fund_verify_photos.each do |f|
                      - if f.photo && f.photo.url
                        .item
                          %a.fancybox-button.zoomer{:href => f.photo.url, 'data-rel' => "fancybox-button"}
                            %span.overlay-zoom
                              = image_tag f.photo.url.split("?")[0] + '?imageView2/5/w/200/h/100/interlace/1',class: "img-responsive"
                              %span.zoom-icon
                  .owl-navigation
                    .customNavigation
                      %a.owl-btn.prev-v2
                        %i.fa.fa-angle-left
                      %a.owl-btn.next-v2
                        %i.fa.fa-angle-right
              - else
                %h2.text-center 还没有证明图片
            -else
              %h2.text-center 请投标后查看
    .row
      .col-md-12
        .panel.panel-grey
          .panel-heading
            .panel-title
              %label.mr40
                申购记录
              %label.mr15
                %span 人次：
                %span= @invests.count
              %label
                %span 投标总额：
                %span
                  = @invests.sum(:amount)
                  元
          .panel-title
            = render "invest_list"

    .row
      .col-md-12
        .tag-box.tag-box-v3
          评论。。
- @navItem = 'funds'

:javascript
  $(function(){
   $(".unlock_btn").click(function(){
     var unlock_val = $(".unlock_val").val();
     var fund_id = "#{@fund.id}";
     var postdata = {
       "private_code": unlock_val
     };
     var post_url = "/funds/"+fund_id+"/invests/"+"unlock";
     var post_type = 'post';
     $.ajax({
       url: post_url,
       type: post_type,
       dataType: 'json',
       data: JSON.stringify(postdata),
       processData: false,
       headers: {
         'X-CSRF-Token': $("input[name='authenticity_token']").val()
       },
       contentType: "application/json; charset=UTF-8",
       success: function(data) {
         location.reload();
       },
       error: function() {
         console.log("系统繁忙，请稍后再试");
       }
     });
   });
   $.ajax({
     url: "/funds/#{@fund.id}/get_history_data",
     type: 'get',
     contentType: false,
     processData: false,
     success: function (data) {
       var history_ctx = $("#fund_history_chart").get(0).getContext("2d");
        // data = {
        //      labels: [],
        //      datasets: [
        //          {
        //              data: []
        //          },
        //          {
        //              data: []
        //          }
        //      ]
        //  };
       var history_data = {
                             labels: data.labels,
                             datasets: [
                                 {
                                     label: "我的业绩",
                                     fillColor: "rgba(220,220,220,0.2)",
                                     strokeColor: "rgba(230,76,60,1)",
                                     pointColor: "rgba(230,76,60,1)",
                                     pointStrokeColor: "#fff",
                                     pointHighlightFill: "#fff",
                                     pointHighlightStroke: "rgba(220,220,220,1)",
                                     data: data.datasets[0].data
                                 },
                                 {
                                     label: "沪深300",
                                     fillColor: "rgba(151,187,205,0.2)",
                                     strokeColor: "rgba(52,151,218,1)",
                                     pointColor: "rgba(52,151,218,1)",
                                     pointStrokeColor: "#fff",
                                     pointHighlightFill: "#fff",
                                     pointHighlightStroke: "rgba(151,187,205,1)",
                                     data: data.datasets[1].data
                                 }
                             ]
                         };
       var options = {
         pointHitDetectionRadius : 2,
         pointDot : false,
         datasetFill : false,
         scaleFontColor: "#666",
         multiTooltipTemplate: "<%= datasetLabel %> - <%= value %>"
       };
       var historyChart = new Chart(history_ctx).Line(history_data,options);
     },
     error: function () {
       $("#fund_history_chart").hide();
       $("#fund_history_chart").parent().html('<h2 class="text-center p20">还没有历史数据</h2>')
       console.log("get_chart_data error...");

     }
   });
  });
